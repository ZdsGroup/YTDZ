<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../js/leaflet-dev/leaflet.css" />
		<link rel="stylesheet" type="text/css" href="../js/leaflet-awesome/leaflet.awesome-markers.css" />
		<link rel="stylesheet" href="../css/font-awesome.min.css" />
		<script type="text/javascript" src="../js/leaflet-dev/leaflet.js"></script>
		<script type="text/javascript" src="../js/leaflet-awesome/leaflet.awesome-markers.js"></script>
		<script type="text/javascript" src="../js/testdata.js"></script>
		<style type="text/css">
			#map {
				height: 100%;
				width: 100vw;
				overflow: hidden;
			}
			
			.mui-content {
				height: calc(100%);
			}
			/*隐藏地图logo信息*/
			/*.leaflet-container .leaflet-control-attribution {
				display: none;
			}*/
			
			.leaflet-map-control-container {
				bottom: 5px;
				width: 100%;
				position: absolute;
				/*pointer-events: none;*/
				z-index: 1000;
				padding-left: 5px;
				padding-right: 5px;
				text-align: center;
			}
			
			.mui-btn {
				margin-left: 2px;
				/*font-size:small !important;*/
			}
			
			.mui-btn-warning0 {
				background-color: rgba(211, 84, 0, 1.0);
				color: rgba(255, 255, 255, 1);
			}
			
			.mui-btn-warning1 {
				background-color: rgba(241, 196, 15, 1.0);
				color: rgba(255, 255, 255, 1);
			}
		</style>
	</head>

	<body>
		<script src="../js/mui.min.js"></script>
		<script type="text/javascript">
			mui.init();
			var myMap = null;

			//初始化地图
			var initMap = function() {
				myMap = L.map('ytmap', {
					zoomControl: false,
					attributionControl: false
				}).fitWorld();

				L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
					maxZoom: 18,
					attribution: 'leaflet',
					id: 'mapbox.streets'
				}).addTo(myMap);

				function onLocationFound(e) {
					var radius = e.accuracy / 2;

					L.marker(e.latlng).addTo(myMap)
						.bindPopup("You are within " + radius + " meters from this point").openPopup();

					L.circle(e.latlng, radius).addTo(myMap);
				}

				function onLocationError(e) {
					alert(e.message);
				}

				myMap.on('locationfound', onLocationFound);
				myMap.on('locationerror', onLocationError);

				myMap.locate({
					setView: true,
					maxZoom: 16
				});
			};

			//初始化事件
			var initEvent = function() {
				//监听点击事件,获取所有按钮，绑定按钮的点击事件
				mui('#mapToolContainer').on("tap", "button", function(evt) {
					var action = evt.target.value;
					switch(action) {
						case 'featurelist':
							{
								/*mui.openWindow({
									url: 'list.html',
									id: action
								})*/
								//预加载的方式打开
								var list = plus.webview.getWebviewById(action);
								if(list == null) {
									mui.preload({
										url: 'list.html',
										id: action,
										styles: {}, //窗口参数
										extras: {} //自定义扩展参数
									});
								}

								list.show();
								break;
							}
						default:
							showWarnMarksOnMap(action);
							break;
					}
				});
				//触发submit按钮的点击事件
				//mui.trigger(btn, 'tab');
			};

			//初始化应用
			var initApp = function() {
				this.initMap();
				this.initEvent();
			};
			mui.ready(initApp);

			//在地图上显示不同级别的警告对象	
			var warnMarkersLayerGroup = new L.layerGroup();
			var maxZoomShow = 18;
			var warnBounds = null;

			function showWarnMarksOnMap(level) {
				var results = queryWarnMarkers(level);
				if(results != null && results.length > 0) {
					warnMarkersLayerGroup.clearLayers();
					getWarnMarkersLayerGroup(results, level);
					myMap.addLayer(warnMarkersLayerGroup);
					myMap.flyToBounds(warnBounds, {
						maxZoom: maxZoomShow
					});
				} else {
					mui.toast('无查询结果！', {
						duration: 'short',
						type: 'div'
					})
				}
			}
			//请求后台服务获取数据
			function queryWarnMarkers(level) {
				if(level == 'alllevel') {
					return warnMarkersDataLevel1;
					//					return null;
				} else {
					return warnMarkersDataLevel2;
				}
			}
			//生成markers并添加到markerlayergroup
			function getWarnMarkersLayerGroup(results, level) {
				var latLngsArr = new Array();
				for(var i = 0; i < results.length; i++) {
					var iconName = 'home';
					var markColor = 'royal';
					switch(level) {
						case 'alllevel':
							break;
						case 'redlevel':
							{
								iconName = 'spinner';
								markColor = 'red';
								break;
							}
						case 'orangelevel':
							{
								iconName = 'coffee';
								markColor = 'orange';
								break;
							}
						case 'yellowlevel':
							{
								iconName = 'cog';
								markColor = 'yellow';
								break;
							}
						case 'bluelevel':
							{
								iconName = 'star';
								markColor = 'blue';
								break;
							}
						case 'normallevel':
							{
								iconName = 'certificate';
								markColor = 'green';
								break;
							}
						default:
							break;
					}
					var iconObj = L.AwesomeMarkers.icon({
						icon: iconName,
						markerColor: markColor,
						prefix: 'fa',
						spin: true
					});
					var markerX = results[i].x;
					var markerY = results[i].y;
					var markerMsg = results[i].msg;
					var markerObj = new L.marker([markerX, markerY], {
						icon: iconObj
					}).bindPopup(markerMsg);
					warnMarkersLayerGroup.addLayer(markerObj);
					latLngsArr.push(markerObj.getLatLng());

				}
				warnBounds = L.latLngBounds(latLngsArr);
			}

			/*// H5 plus事件处理
						function plusReady() {
							this.initEvent();
						}
						if(window.plus) {
							plusReady();
						} else {
							document.addEventListener('plusready', plusReady, false);
						}*/
		</script>

		<div id="ytmap" class="mui-content">
			<div id="mapToolContainer" class="leaflet-map-control-container">
				<button value='alllevel' type="button" class="mui-btn mui-btn-royal mui-pull-left">全部</button>
				<button value='redlevel' type="button" class="mui-btn mui-btn-danger mui-pull-left">红色预警</button>
				<button value='orangelevel' type="button" class="mui-btn mui-btn-warning0 mui-pull-left">橙色预警</button>
				<button value='yellowlevel' type="button" class="mui-btn mui-btn-warning1 mui-pull-left">黄色预警</button>
				<button value='bluelevel' type="button" class="mui-btn mui-btn-blue mui-pull-left">蓝色预警</button>
				<button value='normallevel' type="button" class="mui-btn mui-btn-success mui-pull-left">正常</button>
				<button value='featurelist' type="button" class="mui-btn mui-btn-royal mui-icon mui-icon-list  mui-btn-blue mui-pull-right">列表视角</button>
			</div>
		</div>

	</body>

</html>